<!-- templates/authentication/dashboard/my_files.html -->
{% extends 'authentication/dashboard/base.html' %}

{% load static %}

{% block title %}My Files - EduShare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/my_files.css' %}">
{% endblock %}

{% block content %}
<div class="my-files-section">
    <h2>My Files</h2>

    <!-- Search Bar -->
    <div class="search-bar mb-4">
        <div class="input-group">
            <input type="text" class="search-input form-control" placeholder="Search files...">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <!-- Search Results Container -->
        <div class="search-results-container position-absolute w-100 bg-white shadow-sm rounded-bottom border mt-1 d-none"></div>
    </div>

    <!-- Upload Files Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-primary" id="upload-files-btn">
            <i class="fas fa-upload me-2"></i>Upload Files
        </button>

        <!-- Sorting and Filtering Options -->
        <div class="d-flex gap-3">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sort-by-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Sort by: Name
                </button>
                <ul class="dropdown-menu" aria-labelledby="sort-by-dropdown">
                    <li><a class="dropdown-item" href="#" data-sort="name">Name</a></li>
                    <li><a class="dropdown-item" href="#" data-sort="size">Size</a></li>
                    <li><a class="dropdown-item" href="#" data-sort="modified">Modified</a></li>
                </ul>
            </div>

            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filter-by-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    All Types
                </button>
                <ul class="dropdown-menu" aria-labelledby="filter-by-dropdown">
                    <li><a class="dropdown-item" href="#" data-filter="all">All Types</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="pdf">PDF</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="image">Image</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="document">Document</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Storage Bar -->
    <div class="storage-bar mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <small>Storage: {{ storage_used.used_formatted }} / {{ storage_used.total_formatted }}</small>
            <small>{{ storage_used.percentage|floatformat:2 }}%</small>
        </div>
        <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: {{ storage_used.percentage }}%;" aria-valuenow="{{ storage_used.percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Files Table -->
    <div class="files-table">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="files-list">
                {% for file in files %}
                <tr>
                    <td>{{ file.name }}</td>
                    <td>{{ file.size }}</td>
                    <td>{{ file.modified }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-action="download" data-file-id="{{ file.id }}">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" data-action="share" data-file-id="{{ file.id }}">
                            <i class="fas fa-share"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" data-action="delete" data-file-id="{{ file.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Infinite Scroll Loader -->
    <div id="loading" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Share File Modal -->
    <div class="modal fade" id="shareFileModal" tabindex="-1" aria-labelledby="shareFileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareFileModalLabel">Share File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- File Details -->
                    <div class="mb-3">
                        <strong id="sharedFileName"></strong>
                        <small id="sharedFileSize" class="text-muted"></small>
                    </div>

                    <!-- Email Input -->
                    <div class="mb-3">
                        <label for="emailInput" class="form-label">Share with people</label>
                        <input type="email" class="form-control" id="emailInput" placeholder="Enter email addresses" multiple>
                        <small class="text-muted">Separate multiple emails with commas.</small>
                    </div>

                    <!-- Access Permissions -->
                    <div class="mb-3">
                        <label class="form-label">Access permissions</label>
                        <select class="form-select" id="accessPermissions">
                            <option value="view">View only</option>
                            <option value="edit">Can edit</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="shareFileButton">Share file</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let page = 1;
    let loading = false;

    // Function to load more files as the user scrolls
    function loadMoreFiles() {
        if (loading) return;
        loading = true;
        document.getElementById('loading').style.display = 'block';

        fetch(`{% url "authentication:recent_files" %}?page=${page + 1}`, {
            headers: {
                'Accept': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.files.length > 0) {
                const filesList = document.getElementById('files-list');
                data.files.forEach(file => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${file.name}</td>
                        <td>${file.size}</td>
                        <td>${file.created_at}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" data-action="download" data-file-id="${file.id}">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" data-action="share" data-file-id="${file.id}">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-file-id="${file.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    filesList.appendChild(row);
                });
                page++;
            }
            loading = false;
            document.getElementById('loading').style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading more files:', error);
            loading = false;
            document.getElementById('loading').style.display = 'none';
        });
    }

    // Infinite scroll event listener
    window.addEventListener('scroll', function() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            loadMoreFiles();
        }
    });

    // File actions (download, share, delete)
    document.getElementById('files-list').addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (!button) return;

        const action = button.dataset.action;
        const fileId = button.dataset.fileId;

        if (action === 'download') {
            // Redirect to the download URL
            window.location.href = `/auth/download-file/${fileId}/`;
        } else if (action === 'delete') {
            // Confirm deletion and send fetch request
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/auth/delete-file/${fileId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Accept': 'application/json',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Remove the file row from the table
                        button.closest('tr').remove();
                    }
                })
                .catch(error => {
                    console.error('Error deleting file:', error);
                    alert('Failed to delete the file.');
                });
            }
        } else if (action === 'share') {
            

            // Get file details
            const fileName = button.closest('tr').querySelector('td').textContent;
            const fileSize = button.closest('tr').querySelector('td:nth-child(2)').textContent;

            // Set file details in the modal
            document.getElementById('sharedFileName').textContent = fileName;
            document.getElementById('sharedFileSize').textContent = fileSize;

            // Show the modal
            const shareFileModalElement = document.getElementById('shareFileModal');
            const shareFileModal = new bootstrap.Modal(shareFileModalElement);
            shareFileModal.show();

            // Handle the share button click
            document.getElementById('shareFileButton').onclick = function() {
                const emails = document.getElementById('emailInput').value.split(',').map(email => email.trim());
                const accessPermission = document.getElementById('accessPermissions').value;

                // Send the share request to the backend
                fetch(`/auth/share-file/${fileId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        emails: emails,
                        access_permission: accessPermission,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('File shared successfully!');
                        shareFileModal.hide();
                    } else {
                        alert('Failed to share the file.');
                    }
                })
                .catch(error => {
                    console.error('Error sharing file:', error);
                    alert('Failed to share the file.');
                });
            };
        }
    });

    // Search functionality
    document.getElementById('search-input').addEventListener('click', function() {
        const query = document.getElementById('search-input').value;
        const filesList = document.getElementById('files-list');

        fetch(`{% url "authentication:search_files" %}?query=${encodeURIComponent(query)}`, {
            headers: {
                'Accept': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            filesList.innerHTML = ''; // Clear existing files
            data.files.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${file.name}</td>
                    <td>${file.size}</td>
                    <td>${file.created_at}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-action="download" data-file-id="${file.id}">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" data-action="share" data-file-id="${file.id}">
                            <i class="fas fa-share"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" data-action="delete" data-file-id="${file.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                filesList.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error searching files:', error);
            alert('Failed to search files.');
        });
    });

    // Sorting and filtering
    document.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            const filterBy = this.dataset.filter;

            if (sortBy) {
                document.getElementById('sort-by-dropdown').textContent = `Sort by: ${this.textContent}`;
                // Placeholder for sorting logic
                alert(`Sort by: ${sortBy}`);
            }

            if (filterBy) {
                document.getElementById('filter-by-dropdown').textContent = this.textContent;
                // Placeholder for filtering logic
                alert(`Filter by: ${filterBy}`);
            }
        });
    });
</script>
{% endblock %}