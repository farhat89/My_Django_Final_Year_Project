<!-- templates/authentication/login.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Faculty Collaboration Platform</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="{% static 'css/login.css' %}" rel="stylesheet" />
  </head>
  <body>
    <div class="bg-overlay">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-12 text-center text-white mt-2 mb-2">
            <h2 class="platform-title">
              Welcome to the Faculty Collaboration Platform
            </h2>
            <p class="platform-title">
              Enhancing academic collaboration through seamless file sharing
            </p>
          </div>
        </div>
        <div class="row justify-content-center">
          <div class="col-md-12">
            <div class="login-card mx-auto">
              <div class="text-center mb-2">
                <i class="fas fa-graduation-cap login-icon"></i>
                <h3>Sign In</h3>
                <p class="text-muted">Access your faculty portal</p>
              </div>
              {% if messages %} {% for message in messages %}
              <div
                class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
              >
                {{ message }}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                ></button>
              </div>
              {% endfor %} {% endif %}
              <form
                id="loginForm"
                method="POST"
                action="{% url 'authentication:login' %}"
              >
                {% csrf_token %}
                <div class="mb-2">
                  <label for="email" class="form-label">Email Address</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fa-regular fa-envelope" aria-hidden="true"></i>
                    </span>
                    {{ form.email }}
                  </div>
                  {% if form.email.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.email.errors|join:", " }}
                  </div>
                  {% endif %}
                </div>

                <div class="mb-2">
                  <label for="password" class="form-label">Password</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fa-solid fa-lock" aria-hidden="true"></i>
                    </span>
                    {{ form.password }}
                    <button
                      type="button"
                      class="password-toggle input-group-text"
                      onclick="togglePassword()"
                    >
                      <i class="far fa-eye" id="password-toggle-icon"></i>
                    </button>
                  </div>
                  {% if form.password.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.password.errors|join:", " }}
                  </div>
                  {% endif %}
                </div>

                <div class="mb-2 role-selector">
                  <label class="form-label">Select Role</label>
                  {{ form.role }} {% if form.role.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.role.errors|join:", " }}
                  </div>
                  {% endif %}
                </div>
                <div class="mb-3 form-check">
                  {{ form.remember_me }}
                  <label class="form-check-label" for="remember"
                    >Remember me</label
                  >
                  {% comment %} 
                  <a
                    href="{% url 'password_reset' %}"
                    class="float-end register-link"
                    >Forgot password?</a
                  >
                  {% endcomment %}
                </div>
                <button
                  type="submit"
                  class="btn btn-success btn-sign-in w-100"
                  id="submitButton"
                >
                  <span id="buttonText">Sign In</span>
                </button>
                {% comment %}
                <div class="text-center mt-3">
                  <span>New faculty member? </span>
                  <a
                    href="{% url 'authentication:register' %}"
                    class="register-link"
                    >Register Now</a
                  >
                </div>
                {% endcomment %}
                <div class="text-center mt-3 support-text">
                  <p>
                    For assistance, contact IT support at<br />
                    support@university.edu
                  </p>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script>
      function togglePassword() {
        const passwordInput = document.getElementById("id_password");
        const toggleIcon = document.getElementById("password-toggle-icon");

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          toggleIcon.classList.remove("fa-eye");
          toggleIcon.classList.add("fa-eye-slash");
        } else {
          passwordInput.type = "password";
          toggleIcon.classList.remove("fa-eye-slash");
          toggleIcon.classList.add("fa-eye");
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const submitButton = form.querySelector("#submitButton");
        const buttonText = submitButton.querySelector("#buttonText");

        // Set loading state
        submitButton.disabled = true;
        buttonText.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Signing in...
            `;

        try {
          const formData = new FormData(form);
          const response = await fetch(form.action, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
            },
            body: JSON.stringify(Object.fromEntries(formData)),
          });

          const data = await response.json();

          if (response.ok) {
            window.location.href = data.redirect_url;
          } else {
            const errorAlert = document.createElement("div");
            errorAlert.className =
              "alert alert-danger alert-dismissible fade show";
            errorAlert.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
            form.insertBefore(errorAlert, form.firstChild);
          }
        } catch (error) {
          console.error("Login error:", error);
          const errorAlert = document.createElement("div");
          errorAlert.className =
            "alert alert-danger alert-dismissible fade show";
          errorAlert.innerHTML = `
                    An error occurred during login. Please try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
          form.insertBefore(errorAlert, form.firstChild);
        } finally {
          submitButton.disabled = false;
          buttonText.textContent = "Sign In";
        }
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", handleSubmit);
    </script>
  </body>
</html>
